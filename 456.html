<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>口罩地圖</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/my.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 vh-100 bg-success">
                <select class="form-select form-select-lg my-3" aria-label=".form-select-lg example" id="cityname">
                    <option selected>---縣市名稱---</option>
                    <option value="1">台北市</option>
                    <option value="2">台中市</option>
                    <option value="3">台南市</option>
                </select>
                <select class="form-select form-select-lg my-3" aria-label=".form-select-lg example" id="areaname">
                    <option selected>---鄉鎮區---</option>
                    <option value="1">西屯區</option>
                    <option value="2">南屯區</option>
                    <option value="3">北屯區</option>
                </select>
                <ul class="list-group" id="mylist" style="height: 80vh; overflow: scroll;">
                    <li class="list-group-item">
                        <h3 class="fw-bold">XXXX藥局</h3>
                        <h5>地址:XXXXXX</h5>
                        <h5>電話:XXXXXX</h5>
                        <p>成人口罩: <span class="h3 text-success fw-bold">99</span>個</p>
                        <p>兒童口罩: <span class="h3 text-danger fw-bold">99</span>個</p>
                    </li>
                </ul>
            </div>
            <div class="col-md-9 bg-warning">
                <div id="map" style="height: 95vh;"></div>
            </div>
        </div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        var citydata; //紀錄所有的縣市鄉鎮資料
        var all_maskdata; //紀錄所有健保藥局資料
        var selectCity; //紀錄選取的縣市名稱
        var selectAreaName; //紀錄選取的鄉鎮區名稱
        var selectCounty; //紀錄選取的縣市名稱的鄉鎮區資料
        var select_mask = []; //紀錄選取縣市鄉鎮區後過濾的藥局資料
        var map;

        $(function () {
            //產生地圖
            map = L.map('map').setView([24.1691112, 120.6129218], 13);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([24.1691112, 120.6129218]).addTo(map)
                .bindPopup('中彰投分署.')
                .openPopup();

            //載入縣市資料
            $.ajax({
                type: "GET",
                url: "js/CityCountyData.json",
                dataType: "json",
                success: showdata_CityCounty,
                error: function () {
                    alert("error");
                }
            });
            //載入口罩地圖資料
            $.ajax({
                type: "GET",
                url: "js/points.json",
                dataType: "json",
                success: showdata,
                error: function () {
                    alert("error");
                }
            });

            //監聽cityname change
            $("#cityname").change(function () {
                console.log($(this).val());
                selectCity = $(this).val();
                citydata.find(function (item) {
                    if (item.CityName == selectCity) {
                        selectCounty = item.AreaList;
                    }
                });
                console.log(selectCounty);
                $("#areaname").empty();
                $("#areaname").append('<option disabled selected>---鄉鎮區名稱---</option>');
                selectCounty.forEach(function (item) {
                    var strHTML = '<option value="' + item.AreaName + '">' + item.AreaName + '</option>';
                    $("#areaname").append(strHTML);
                });
            });

            //監聽areaname change
            $("#areaname").change(function () {
                console.log($(this).val());
                selectAreaName = $(this).val();
                //測試 印出所選取的縣市和鄉鎮區名稱
                console.log(selectCity);
                console.log(selectAreaName);
                //篩選出所選取的縣市鄉鎮區 的 藥局資料
                select_mask = [];
                all_maskdata.forEach(function (item) {
                    if (item.properties.county == selectCity && item.properties.town == selectAreaName) {
                        console.log(item);
                        select_mask.push(item);
                    }
                });
                console.log(select_mask);
                //渲染過濾後的藥局資料
                //渲染過濾後的marker資料
                $("#mylist").empty();
                select_mask.forEach(function (item) {
                    var strHTML = '<li class="list-group-item"><h3 class="fw-bold">' + item.properties.name + '</h3><h5>地址:' + item.properties.address + '</h5><h5>電話:' + item.properties.phone + '</h5><p>成人口罩: <span class="h3 text-success fw-bold">' + item.properties.mask_adult + '</span>個</p><p>兒童口罩: <span class="h3 text-danger fw-bold">' + item.properties.mask_child + '</span>個</p></li>';
                    $("#mylist").append(strHTML);
                    //修改popup內容 顯示該藥局多筆屬性資料
                    var lat = item.geometry.coordinates[1];//經度
                    var lng = item.geometry.coordinates[0];//緯度
                    L.marker([lat, lng]).addTo(map)
                        .bindPopup(item.properties.name)
                        .openPopup();
                });
            });
        });

        function showdata(data) {
            console.log(data.features);
            all_maskdata = data.features;

        }

        function showdata_CityCounty(data) {
            console.log(data);
            citydata = data;


            $("#cityname").empty();
            $("#cityname").append('<option disabled selected>---縣市名稱---</option>');
            data.forEach(function (item) {
                console.log(item.CityName);
                var strHTML = '<option value="' + item.CityName + '">' + item.CityName + '</option>';
                $("#cityname").append(strHTML);
            });
        }
    </script>
</body>

</html>
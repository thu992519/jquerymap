<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>口罩地圖openmap</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/mystyle.css">
    <link rel="stylesheet" href="./leaflet/leaflet.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 vh-100 bg-success">
                <select class="mt-5 form-select form-select-lg mb-3" aria-label=".form-select-lg example" id="cityname">
                    <option selected>--縣市名稱--</option>
                    <option value="1">台北</option>
                    <option value="2">台中</option>
                    <option value="3">台南</option>
                  </select>
                  <select class="form-select form-select-lg mb-3" id="areaname" aria-label=".form-select-lg example">
                    <option selected>--鄉鎮名稱--</option>
                    <option value="1">西屯</option>
                    <option value="2">北屯</option>
                    <option value="3">龍井</option>
                  </select>
                  <ul class="list-group" id="mylist" style="height: 80vh; overflow: scroll;">
                    <li class="list-group-item">
                        <h3 class="fw-bold">XXXX藥局</h3>
                        <h5>地址:XXXXXX</h5>
                        <h5>電話:XXXXXX</h5>
                        <p>成人口罩: <span class="h3 text-success fw-bold">99</span>個</p>
                        <p>兒童口罩: <span class="h3 text-danger fw-bold">99</span>個</p>
                    </li>
                </ul>
            </div>
            <div class="col-md-9 vh-100 bg-warning">
                <div id="map" class="mt-5" style="height:92vh"></div>
            </div>
        </div>
    </div>
    

    <script src="./leaflet/leaflet.js"></script>
    <script src="./js/bootstrap5.bundle.min.js"></script>
    <script src="./js/jquery-3.7.1.min.js"></script>
    <script>
        let citydata; //紀錄所有的縣市鄉鎮資料
        let all_maskdata; //紀錄所有健保藥局資料
        let selectCity; //紀錄選取的縣市名稱
        let selectAreaName; //紀錄選取的鄉鎮區名稱
        let selectCounty; //紀錄選取的縣市名稱的鄉鎮區資料
        let select_mask = []; //紀錄選取縣市鄉鎮區後過濾的藥局資料
        let map;


        $(function(){
            map = L.map('map').setView([24.1691112, 120.6129218], 13);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
           


            $.ajax({
                type:"GET",
                url:"points.json",
                dataType:"json",
                success:showdata,
                error:function(){
                    alert("資料錯誤");
                }

            })

            //載入縣市資料
            $.ajax({
                type:"GET",
                url:"CityCountyData.json",
                dataType:"json",
                success:showdata_CityCounty,
                error:function(){
                    alert("資料錯誤");
                }

            })
        })

        //監聽cityname change
        $("#cityname").change(function(){
            selectCity=$(this).val();
            citydata.forEach(function(item){
                if(item.CityName == selectCity){
                        selectCounty = item.AreaList;
                    }
            });
       
            $("#areaname").empty();
            $("#areaname").append('<option disabled selected>---鄉鎮區名稱---</option>');
                selectCounty.forEach(function(item){
                    var strHTML = '<option value="' + item.AreaName+ '">' + item.AreaName +'</option>';
                    $("#areaname").append(strHTML);
                });
        })
        //監聽areaname change
        $("#areaname").change(function () {
                //  removeMarker();
                console.log($(this).val());
                selectAreaName = $(this).val();
                //測試 印出所選取的縣市和鄉鎮區名稱
                console.log(selectCity);
                console.log(selectAreaName);
                //篩選出所選取的縣市鄉鎮區 的 藥局資料
                select_mask = [];
                all_maskdata.forEach(function (item) {
                    if (item.properties.county == selectCity && item.properties.town == selectAreaName) {
                        // console.log(item);
                        select_mask.push(item);
                    }
                });
                console.log(select_mask);
                //渲染過濾後的藥局資料
                //渲染過濾後的marker資料
                $("#mylist").empty();
                 removeMarker();

                select_mask.forEach(function (item,key) {
                    var strHTML = '<li class="list-group-item"><h3 class="fw-bold">' + item.properties.name + '</h3><h5>地址:' + item.properties.address + '</h5><h5>電話:' + item.properties.phone + '</h5><p>成人口罩: <span class="h3 text-success fw-bold">' + item.properties.mask_adult + '</span>個</p><p>兒童口罩: <span class="h3 text-danger fw-bold">' + item.properties.mask_child + '</span>個</p></li>';
                    $("#mylist").append(strHTML);
                    //修改popup內容 顯示該藥局多筆屬性資料
                     
                   
                    var lat = item.geometry.coordinates[1];//經度
                    var lng = item.geometry.coordinates[0];//緯度
                    L.marker([lat, lng]).addTo(map)
                        .bindPopup(`<div class="card border-primary mb-3" style="max-width: 18rem;">
                                    <div class="card-header">${item.properties.name}</div>
                                    <div class="card-body ">
                                    <p class="card-text">地址:${item.properties.address}</p>
                                    <p class="card-text">電話:${item.properties.phone}</p>
                                    <p class="card-text">成人口罩:<span class="h3 text-success fw-bold">${item.properties.mask_adult}</span>個</p>
                                    <p class="card-text">兒童口罩:<span class="h3 text-danger fw-bold">${item.properties.mask_child}</span>個</p>
                                    </div>
                                    </div>`)
                        .openPopup();
                        // console.log(lat);
                        // console.log(lng);
                        // console.log(select_mask.length/2);
                        if(key== select_mask.length-1){
                            map.panTo([lat,lng])
                        }
                       
                });
            });

            function removeMarker(){
                map.eachLayer(function(layer){
                    if (layer instanceof L.Marker){
                        map.removeLayer(layer);
                    }
                })
            }

        function showdata (data){
            // console.log(data);
            all_maskdata = data.features;

        }
        function showdata_CityCounty(data){
            let str='';
            citydata = data;
            console.log(data);
            $("#cityname").empty();
            $("#cityname").append("<option disabled selected>--縣市名稱--</option>");
            data.forEach((item)=>{
                str+=`<option value="${item.CityName}">${item.CityName}</option>`;
            })
            $("#cityname").append(str);
           

           
            
        }
    </script>

</body>
</html>